<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Page Title</title>
    <style>
      form{
      margin: 15px;
      }
    </style>
  </head>
  <body>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
    <!-- START -->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-firestore.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use   https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-analytics.js"></script>
    <script>
      /* Your web app's Firebase configuration*/
        const firebaseConfig = {
  apiKey: "AIzaSyAjSAelAkl02y2tFh1LBQVrGFRy7AKuWDE",
  authDomain: "vipatra-dev.firebaseapp.com",
  databaseURL: "https://vipatra-dev.firebaseio.com",
  projectId: "vipatra-dev",
  storageBucket: "vipatra-dev.appspot.com",
  messagingSenderId: "667984536045",
  appId: "1:667984536045:web:1c9cb22d3e8c1167ed87e4",
  measurementId: "G-HTXPXY19KH"
};
      /*Change till here*/
      /* Initialize Firebase*/
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>
    <!--  END Firebase initial -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">
        <img src="https://1.bp.blogspot.com/-CWPWZTQSjww/XuH3IYjieDI/AAAAAAAAEmU/DbkwEeNRGBQZfMiBy9mykJfdZ_s1GiXJgCK4BGAsYHg/s500/20200611_101417_0000.png" width="30" height="30" class="d-inline-block align-top" alt="" loading="lazy" >
        Vipatra
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/store/dashboard">New Bill</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/reports">Reports</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/account">Account</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Help</a>
          </li>
        </ul>
      </div>
    </nav>
    <br>
    <div class="container">
      <div class="row">
        <div class="col-8">
          <h6>Total amount</h6>
          <h4 id="form-total-amount"></h4>
        </div>
        <div class="col-4">
          <div id="div-submit-button">
            <button class="btn btn-success" id="submit-button" onClick="html2json()" data-toggle="modal" data-target="#send-bill-modal">
            <b>Send bill</b>
            </button>
          </div>
        </div>
    </div>
    </div>
    <form id="bill-input-form">
      <div class="form-group">
        <label for="form-item-name">Item name</label>
        <textarea class="form-control" id="item" rows="2"></textarea>
      </div>
      <div class="form-row">
        <div class="col">
          <label for="form-quantity">Qty</label>
          <input id="form-quantity"type="number" class="form-control" placeholder="Quantity" required>
        </div>
        <div class="col">
          <label for="form-rate">Rate</label>
          <input id="form-rate" type="number" class="form-control" placeholder="Rate" required>
        </div>
      </div>
      <br>
      <div class="text-right">
      <button type="submit" id="button-add-item" class="btn btn-primary">
        <b>+ Add item</b>
      </button>
    </div>
    </form>
    <br>
    <table class="table" id="table-bill">
      <thead id="table-head">
        <tr id="table-head">
          <th>Item</th>
          <th>Qty</th>
          <th>Rate</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody id="table-body-bill">
      </tbody>
    </table>
    </center>
    <!--customer code modal-->
    <!--Submit modal-->
    <div class="modal fade" id="send-bill-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Enter User code</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
              <input type="number" id="input-customer-code" class="form-control" placeholder="User code" required>
            </div>
            <div class="form-group">
              <label>Date</label>
              <input id="form-date" type="text" class="form-control">
              <small>Format date-month-year. e.g. 20-06-2020. put colon.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button id="send-bill" type="button" class="btn btn-primary btn-block">
              <b>Send bill</b>
            </button>
            <div id="bill-sent-div" class="d-none text-center">
              <h4 class="text-success">Bill sent! Successfully</h4>
            </div>
          </div>
            </form>
        </div>
      </div>
    </div>
    <script> 
      $('#button-add-item').click((e) => {
        e.preventDefault();
        var rev_date =$('#form-date').val();
        rev_date = rev_date.split("-").reverse().join("-")
        console.log(rev_date);
        addRow();
      });
      $('#send-bill').click(async function (e){
        e.preventDefault();
          await upload_bill();
          bill_sent();        
      });
      function bill_sent(){
        $('#send-bill').addClass('d-none');
        $('#bill-sent-div').removeClass('d-none');
        $('#table-body-bill').empty();
        $('#send-bill-modal').modal('hide');
        $('#bill-sent-div').addClass('d-none');
        $('#send-bill').removeClass('d-none');
      }
      function getUserId(){
        var user = auth.currentUser; 
        console.log(user.uid);
        return (user.uid);
      }     
      function total(){
        var rate = $('#form-rate').val();
        var qty = $('#form-quantity').val();
        result = parseFloat(rate) * parseFloat(qty);
        result=result.toFixed(2);
        $('#form-total').val(result);
        return result;
      }   
      var total_amount=0;
      function addRow() {
        "use strict";
        var tableBody = document.getElementById("table-body-bill");
        var td1 = document.createElement("td");
      var td2 = document.createElement("td");
      var td3 = document.createElement("td"); 
      var td4 = document.createElement("td");   
      var row = document.createElement("tr");
      
      td1.innerHTML = document.getElementById("item").value;
      td2.innerHTML = document.getElementById('form-quantity').value;
      td3.innerHTML = document.getElementById('form-rate').value;
      td4.innerHTML = total();
       row.appendChild(td1);
       row.appendChild(td2);
       row.appendChild(td3);
       row.appendChild(td4);
      tableBody.appendChild(row);
      document.getElementById('bill-input-form')
      .reset();
      //calcultaing bill total
            var table_data = document.getElementById('table-body-bill');
            var table_length= table_data.rows.length;
            for(var i=table_length-1;i<table_length;i++){
              total_amount = parseFloat(total_amount)+ parseFloat(table_data.rows[i].cells.item(3).innerHTML);
      }
      console.log(total_amount);
      $('#form-total-amount').html('â‚¹' + total_amount);
      }
      /*getting seller info*/
      var seller_id,store_name,seller_doc_id;
      /*converting table data to json*/
      var json_table_data,i=0;;
      function html2json() {
          json_table_data='[';
          var otArr = [];
          var tbl2 = $('#table-bill tbody tr').each(function(e) {        
          x = $(this).children();
          var itArr = [];
          var keys = ['name','quantity','price','total'];
          x.each(function(i) {
          itArr.push('"' + keys[i] + '":"' + $(this).text() + '"');
          });
          otArr.push('{' + itArr.join(',') + '}');
          })
     json_table_data += otArr.join(",") + ']';
     console.log(json_table_data);  
       }  
      /*END json conversion*/
      var str;
      async function upload_bill(){
        var sel_uid = await getUserId();
        var sdate = $('#form-date').val(); 
        var u_code = $('#input-customer-code').val();
       await getStoreDetails();
       console.log(str);
        db.collection('bill')
        .add({
          sellerUID : sel_uid,
          userCode :  u_code,
          date : sdate,
          storeName : str,
          totalAmount : total_amount,
          bill : JSON.parse(json_table_data)     
        }).then(() => {
        console.log("success")
        total_amount = 0;
        $('#form-total-amount').html('0');
        upload_transaction();
        });
      }
      async function upload_transaction(){
        var user_id = await getUserId();
        var bdate = $('#form-date').val();
        var docRef = db.collection('store').doc(user_id).collection('transaction').doc(bdate);
        docRef.set({
          date : bdate,
          amount :  ''  
        });
      }
      async function getStoreDetails(){
        var user_id = await getUserId();
        var docRef = db.collection('store').doc(user_id).collection('account').doc('info');
        docRef.get()
        .then((doc) => {
          str = doc.data().storeName;
        })   
      }
      function date(){
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();

today = dd + '-' + mm + '-' + yyyy;
        console.log(today);
        $('#form-date').val(today);
      }
      date();      
    </script>
    <!-- JS, Popper.js, and jQuery -->
    <script defer src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script defer src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script> 
  </body>
</html>
