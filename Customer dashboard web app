<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Title</title>
  </head>
  <body>
    <style>
      .back-button{
      margin: 19px;
      text-align: right;
      }
      .bill-box{
      background-color: white;
      width:95%;
      border: 1px solid grey;
      border-radius: 5px;
      padding: 5px;
      box-shadow: 1px 1px 6px #888888;
      max-width: 500px;
      margin: auto;
      }
      #bill-box {
      margin: 5px;
      }
      #view-bill{
      max-width: 90%;
      }
      .card{
      width: 95%;
      max-width: 400px;
      height: 90px;
      max-height:100px;
      word-break:break-all;
      box-shadow: 1px 1px 6px #888888;
      margin: 0 auto;
      margin-bottom: 10px; 
      }
      #b-storename{
      position:absolute;
      max-width:70%;
      word-break:break-word;
      padding: 3px;
      top: 5%;
      display:block; 
      display:flex;
      left:3%;
      align-items: top;
      font-weight: bold;
      }
      #b-date{
      position: absolute;
      display: flex;
      bottom:5%;
      padding:5px;
      left: 3%;
      color: grey;
      }
      #b-amount{ 
      position: absolute;
      top: 5px;
      right: 5px;
      padding:5px;
      }
      #dropdown-menu-button{
      margin: 10px;
      }
      #dropdownMenuButton, .your-bills{
      display: inline;
      }
      #bills-offer-header{
      margin: 3px;
      width: 95%;
      }
    </style>
    <!--START-Bootstrap-cdn-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <!--END_Bootstarap_cdn-->
    <!-- START -->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-firestore.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use     https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-analytics.js"></script>
    <script>
      // Your web app's Firebase configuration
      const firebaseConfig = {
      apiKey: "AIzaSyAjSAelAkl02y2tFh1LBQVrGFRy7AKuWDE",
      authDomain: "vipatra-dev.firebaseapp.com",
      databaseURL: "https://vipatra-dev.firebaseio.com",
      projectId: "vipatra-dev",
      storageBucket: "vipatra-dev.appspot.com",
      messagingSenderId: "667984536045",
      appId: "1:667984536045:web:1c9cb22d3e8c1167ed87e4",
      measurementId: "G-HTXPXY19KH"
      };
      ///Change till here
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
      const db = firebase.firestore();
      const auth = firebase.auth();
      //const auth = firebase.auth();  
    </script>
    <!--  END Firebase initial -->
    <div id="bd">
      <!--nav menu-->
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">
        <img src="https://1.bp.blogspot.com/-CWPWZTQSjww/XuH3IYjieDI/AAAAAAAAEmU/DbkwEeNRGBQZfMiBy9mykJfdZ_s1GiXJgCK4BGAsYHg/s500/20200611_101417_0000.png" width="30" height="30" class="d-inline-block align-top" alt="" loading="lazy" >
        Vipatra
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="#">Logout</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Help</a>
            </li>
          </ul>
        </div>
      </nav>
      <center>
        <br>
        <h4 class="your-bills">Your bills</h4>
        <br><br>
        <span id="user-code">user code</span>
        <br><br>
      </center>
      <div id='table-elements'>
        <table class="table is-fullwidth" id="ex-table">
          <tr id="bl-heading">
        </table>
        <div class="text-center">
          <button class="btn btn-outline-primary" id="next-page">More bills</button>
        </div>
      </div>
      <br>
      <div class="text-center">
        <div class="spinner-border loader" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      </center>
      <script>  
        var user_id;
        //get_user_id();
        show_bill();
          //$('#table-elements').hide();
          const billList = document.querySelector("#bill-list");
          //create element and render bills
          var docID;
          function renderBills(doc){
          var content = '';
           var i, val = doc.data();
            docID = doc.id;
            console.log(val.bill[0].price);
           content += '<div class="card" onclick="javascript:showRow(this);">';
           content += '<div class="card-body">';
           content += '<div class="card-title" id="b-storename">' + val.storeName + '</div>';
           content += '<span class="card-text" id="b-date">' + val.date + '</span>';
           content += '<div id="b-amount">' + 'â‚¹' + val.totalAmount + '</div>';
           content += '<span id="docid" hidden>' + doc.id + '</span>';
           content += '<div id="b-bill" hidden>' + val.bill + '</bill>';
           content += '</div>';
           content += '</div>';
          $('#ex-table').append(content);         
          console.log(doc.id);
          i++;   
          }
          async function show_bill(){
           // var user_code = await getUserId();
            var docRef = db.collection('bill')
            .where('userCode','==', '6967438728')
            .limit(5);
            docRef           
            .get()
            .then((snapshot) => {
              snapshot.docs.forEach(async doc => {
               renderBills(doc);
               $('#b-amount').html(doc.data().amount);
               $('#table-elements').show();
               $('.loader').hide();        
               console.log(docID);  
              })
            }).catch(() => {
              document.write('no billa');  
            });
          }
          //showing more bills
          $('#next-page').click(()=>{
          db.collection("finalbill")
          .where('userId','==',user_id)
         /* .orderBy('date','desc')*/
          .startAfter(docID)
          .limit(5)
          .get()
          .then((snapshot) => {
          snapshot.docs.forEach(doc => {
             renderBills(doc);
          })
          });
          })
          function getUserId(){
            var user = auth.currentUser;
            user_id = user.uid;
            return (user.uid);
            document.write(user.uid);
          }
          function getting_user_code(){   
            var user_code;
            var user = auth.currentUser;
            if(user){
              db.collection('user')
              .doc(user.uid)
              .get()
              .then((doc) => {            
             $ ('#user-code').html(doc.data().userCode);
                user_code = doc.data().userCode;
              });
            }             
            return user_code;
          }
      </script>
    </div>
    <div id="viewBill" class="d-none">
      <!-- START Bill view -->
      <center>
      <br>
      <h5 id="store-name">Store name</h5>
      <br>
      <span id="">Paid</span> 
      <br>  
      <h2 class="text-success" id="amount-h"></h2>
      <br>
      <div class=" bill-box">
        Date:&nbsp;<span id="bl-date"></span>
        <br>
        Transaction ID:&nbsp;<span id="trans-id"></span>
        <br><br>
        <center>
          <div class="text-center">
            <div class="spinner-border loader text-center" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
          <div id='bill-view-table'>
            <table class="table" id="billView">
            </table>
          </div>
          <br>
          <span id="total"></span>
      </div>
      </center> 
      <div class="back-button">   
        <button class="back-button btn btn-primary" onclick="backButton()">back</button>
      </div>
      <!-- END Bill view  -->
      <script>
        //row click show data
        function showRow(row){         
          $('#bill-view-table').addClass('d-none');
          $('.loader').removeClass('d-none');     
          $("#bd").addClass('d-none');    
          $("#viewBill").removeClass('d-none');
          $('#store-name').html($(row).find('#b-storename').html());
          $('#amount-h').html($(row).find('#b-amount').html());
          $('#trans-id').html($('#docid').html());
          $('#bl-date').html($('#b-date').html());
        //retain till here
        /*showing full bill*/
          var myList;
          console.log('hg' + $(row).find('#docid').html());
        db.collection('bill')
        .doc($(row).find('#docid').html())
        .get()
        .then(doc=>{
        myList=doc.data().bill;
        console.log(doc.data());
        }).then(()=>{
        console.log(myList.amount)
        buildHtmlTable('#billView');
        $('#bill-view-table').removeClass('d-none');
        $('.loader').addClass('d-none');
        });
        /*building html table */
        /* Builds the HTML Table out of myList.*/
        function buildHtmlTable(selector) {
        var columns = addAllColumnHeaders(myList, selector);
        for (var i = 0; i < myList.length; i++) {
        var row$ = $('<tr/>');
        for (var colIndex = 0; colIndex < columns.length; colIndex++) {
        var cellValue = myList[i][columns[colIndex]];
        
        if (cellValue == null) cellValue = "";
        row$.append($('<td/>').html(cellValue));
        }
        $(selector).append(row$);
        }
        }   
        }
        // Adds a header row to the table and returns the set of columns.
        // Need to do union of keys from all records as some records may not contain
        // all records.
        function addAllColumnHeaders(myList, selector) {
          var columnSet = [];
          var headerTr$ = $('<tr/>');
         for (var i = 0; i < myList.length; i++) {
          var rowHash = myList[i];
           for (var key in rowHash) {
            if ($.inArray(key, columnSet) == -1) {
             columnSet.push(key);
        /*changing the header names */
             if(key=="name"){
                 key="Item";
             }
             else if(key=="price"){
                 key="Rate";
             }
             else if(key=="quantity"){
                 key="Qty";
             }
             else if(key=="total"){
                 key="Amount";
             }
              headerTr$.append($('<th/>').html(key));
              }
            }
          }
          $(selector).append(headerTr$);
          return columnSet;
        }
        /*END table building*/ 
        function backButton(){
          $("#bd").removeClass('d-none');
          $("#viewBill").addClass('d-none');
          $('#billView').empty();
        }
        $('#dropdown-logout').click(() => {
            auth.signOut().then(() => {
                console.log('logout successful');
            });
        });
        /*building html table */
        /*Builds HTML Table out of myList*/
        function buildHtmlTable(selector) {
        var columns = addAllColumnHeaders(myList, selector);
          for (var i = 0; i < myList.length; i++) {
            var row$ = $('<tr/>');
            for (var colIndex = 0; colIndex < columns.length; colIndex++) {
              var cellValue = myList[i][columns[colIndex]];
              
              if (cellValue == null) cellValue = "";
              row$.append($('<td/>').html(cellValue));
            }
            $(selector).append(row$);
          }
        }  
      </script>
    </div>
  </body>
</html>
