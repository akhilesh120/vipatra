<!DOCTYPE html>

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Page Title</title>
  </head>
  <body>
    <style>
      #signup-form, #login-form {
        max-width: 80%;
      }

      #signup-form {
        margin: 5px;
      }

      #signup-submit-button {
        margin: 5px;
      }
      #invalid-signup-alert-box{
          margin: 10px;
      }
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <!-- START -->
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-analytics.js"></script>
    <script>
/*web app Firebase config*/
     const firebaseConfig = {
  apiKey: "AIzaSyAjSAelAkl02y2tFh1LBQVrGFRy7AKuWDE",
  authDomain: "vipatra-dev.firebaseapp.com",
  databaseURL: "https://vipatra-dev.firebaseio.com",
  projectId: "vipatra-dev",
  storageBucket: "vipatra-dev.appspot.com",
  messagingSenderId: "667984536045",
  appId: "1:667984536045:web:1c9cb22d3e8c1167ed87e4",
  measurementId: "G-HTXPXY19KH"
};
      /*Change till here*/
      /* Initialize Firebase*/
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();      
      const db = firebase.firestore();
      const auth = firebase.auth();
    </script>
    <!--  END Firebase initial -->
    <center>
      <form id="signup-form">
        <h3 id="header-signup">Signup</h3>
        <br>
        <div class="form-group">
          <input type="email" class="form-control" id="signup-email" aria-describedby="emailHelp" placeholder="Enter email" />
          <small id="code-digit" class="form-text text-muted">
          6-digit code will be sent for verification.
          </small>
        </div>
        <div class="form-group">
          <input type="password" class="form-control" id="signup-password" placeholder="Password" />
        </div>
        <button type="submit" id="signup-submit-button" class="btn btn-success btn-block">            
        <b id="create-account">Create Account</b>            
        </button>
      <div>
        <hr>
          or
        <hr>
      </div>
      <button id="login-button" class="btn btn-primary">          
        <b>Login</b>          
      </button>
      </form>
    </center>
    <div id="invalid-signup-alert-box" class="alert alert-danger d-none" role="alert">
    </div>
    <script>
      $('#login-button').click((e)=>{
        e.preventDefault();
        window.location.href = '/user/login';  
      });
      $('email-verified').click(() => {
        window.location.href = "/store-data";   
      });
      var new_user_id;
      $("#signup-submit-button").click((e) => {
        e.preventDefault();
        var email = $("#signup-email").val();
        var password = $("#signup-password").val();        auth.createUserWithEmailAndPassword(email, password).then(() => {
          auth.onAuthStateChanged((user) => {
            if(user) {
              new_user_id = user.uid;
              console.log(new_user_id);
              customer_code_generator();
              console.log('hi');
            }
          });
          }).then(()=>{
          console.log("signup_successful");
          }).catch((error) => {
            console.log(error.message);
            $('#invalid-signup-alert-box').removeClass('d-none');
            $('#invalid-signup-alert-box').html(error.message + ' Do not give up! Please try again.');
        });
      
});
var customer_code = '';
      function customer_code_generator() {
        customer_code = '';
        var ALPHABET = "123456789";
        for (var i = 0; i < 10; i++) {
          customer_code += ALPHABET.charAt(Math.floor(Math.random() * ALPHABET.length));
        }
        ddq();
      }
      function ddq() {
        db.collection('user')
        .where("userCode", "==", customer_code)
        .limit(1)
        .get()
        .then((docSnapshot) => {
          docSnapshot.forEach((doc)=>{
            if(doc.exists) {
              console.log("doc exists");
              customer_code_generator();
            }
          })
        }).then(() => {
          console.log(customer_code);
          db.collection("user")
          .doc(new_user_id)
          .set({
            userCode : customer_code
          });
          console.log(customer_code);
          }).then(() => {
            verify_email();
            });
      }
      function show_login_form(){
        $('#header-signup').html('Login');
        $('#code-digit').html('');
        $('#create-account').html('Login');               
      }
      function verify_email(){
        var user = auth.currentUser;
        user.sendEmailVerification().then(() =>{
          console.log('sent');
          window.location.href = '/user/email-verify';
        });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  </body>
</html>
